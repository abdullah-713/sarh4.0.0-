# 6. النظام المالي

## 6.1 نظرة عامة

يعتمد نظام مؤشر صرح المالي على مبدأ **تحويل الراتب إلى قيمة زمنية** (تكلفة الدقيقة). كل دقيقة تأخير أو غياب تُحوَّل إلى خسارة مالية قابلة للقياس.

```
┌─────────────────────────────────────────────────────────────────┐
│                    المحرك المالي لسهر                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   الراتب الإجمالي = أساسي + سكن + نقل + أخرى                   │
│                                                                 │
│   دقائق العمل الشهرية = أيام_العمل × ساعات_اليوم × 60          │
│                  مثال = 22 × 8 × 60 = 10,560 دقيقة             │
│                                                                 │
│   تكلفة الدقيقة = الراتب الإجمالي ÷ دقائق_العمل_الشهرية       │
│            مثال = 10,000 ÷ 10,560 = 0.9470 ر.س/دقيقة          │
│                                                                 │
│   تكلفة التأخير = دقائق_التأخير × تكلفة_الدقيقة               │
│            مثال = 30 دقيقة × 0.9470 = 28.41 ر.س                │
│                                                                 │
│   قيمة الإضافي = دقائق_الإضافي × تكلفة_الدقيقة × 1.5          │
│            مثال = 60 دقيقة × 0.9470 × 1.5 = 85.23 ر.س          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6.2 الخصائص المحسوبة في نموذج User

```php
// الراتب الإجمالي
$user->total_salary = basic_salary + housing_allowance 
                    + transport_allowance + other_allowances;

// دقائق العمل الشهرية
$user->monthly_working_minutes = working_days_per_month 
                               × working_hours_per_day × 60;

// تكلفة الدقيقة (من الإجمالي)
$user->total_cost_per_minute = total_salary / monthly_working_minutes;

// تكلفة الدقيقة (من الأساسي فقط)
$user->cost_per_minute = basic_salary / monthly_working_minutes;
```

---

## 6.3 اللقطة المالية (Financial Snapshot)

> **مبدأ مهم**: عند تسجيل الحضور، تُجمّد قيمة `cost_per_minute` في سجل الحضور. حتى لو تغيّر الراتب لاحقًا، يظل الحساب بالقيمة وقت التسجيل.

```php
// AttendanceService::checkIn()
$log->calculateFinancials();
// ↓ تُنسخ تكلفة_الدقيقة من الموظف → سجل الحضور
// $log->cost_per_minute = $user->total_cost_per_minute

// AttendanceService::checkOut()
$log->delay_cost       = delay_minutes × cost_per_minute
$log->early_leave_cost = early_leave_minutes × cost_per_minute
$log->overtime_value   = overtime_minutes × cost_per_minute × 1.5
```

---

## 6.4 كشوف الرواتب (Payroll)

### توليد الكشف

الأمر: `php artisan sarh:payroll --period=2026-02 --branch=1`

```
لكل موظف نشط:
  1. نسخ بيانات الراتب الحالية (أساسي + بدلات)
  2. تجميع سجلات الحضور للفترة:
     - أيام الحضور / الغياب / التأخر
     - إجمالي دقائق التأخير
     - إجمالي دقائق الإضافي
  3. حساب الخصومات:
     - خصم التأخير = مجموع delay_cost من attendance_logs
     - خصم الغياب = أيام_الغياب × (الراتب_اليومي)
     - خصم المغادرة المبكرة = مجموع early_leave_cost
  4. حساب الإضافات:
     - أجر الإضافي = مجموع overtime_value
     - مكافآت (يدوي)
  5. صافي الراتب = إجمالي - خصومات + إضافات
```

### دورة حياة الكشف

```
draft (مسودة) → approved (معتمد) → paid (مدفوع)
```

- **draft**: يمكن تعديله
- **approved**: لا يمكن تعديله إلا بإلغاء الاعتماد (مستوى 8+)
- **paid**: مؤرشف

---

## 6.5 خدمة التقارير المالية (FinancialReportingService)

### `getDailyLoss($date, $branchId?)`
إجمالي خسائر التأخير ليوم محدد. مخزن مؤقتًا 5 دقائق.

### `getBranchPerformance($month)`
أداء كل فرع شهريًا:
- عدد الموظفين، عدد السجلات
- نسبة الحضور في الوقت / التأخر / الغياب
- انتهاكات السياج الجغرافي ونسبة الالتزام
- إجمالي الخسارة، الدرجة:

| الدرجة | نسبة الحضور في الوقت |
|--------|----------------------|
| ممتاز | ≥ 95% |
| جيد | ≥ 85% |
| متوسط | ≥ 70% |
| ضعيف | < 70% |

### `getDelayImpactAnalysis($start, $end, $scope, $scopeId?)`
تحليل عائد الانضباط (ROI):
- الخسارة المحتملة (بدون نظام تحفيز) = الخسارة الفعلية × 1.3
- الخسارة الفعلية
- التوفير = المحتملة - الفعلية
- ROI% = (التوفير / المحتملة) × 100

### `getPredictiveMonthlyLoss($month)`
توقع الخسارة الشهرية:
- أيام العمل المنقضية
- الخسارة المتراكمة
- متوسط الخسارة اليومية
- التوقع = المتوسط × 22 يوم عمل

---

## 6.6 محرك المعادلات (FormulaEngineService)

يتيح إنشاء **معادلات مخصصة** تُقيَّم عبر مكتبة Symfony ExpressionLanguage:

### المتغيرات المتاحة (13 متغيرًا)

| المتغير | الوصف |
|---------|-------|
| `attendance` | نسبة الحضور (%) |
| `delay_rate` | نسبة التأخر (%) |
| `on_time_rate` | نسبة الحضور في الوقت (%) |
| `total_points` | مجموع نقاط الموظف |
| `overtime_rate` | نسبة الإضافي (%) |
| `early_leave_rate` | نسبة المغادرة المبكرة (%) |
| `financial_loss` | الخسارة المالية (ر.س) |
| `task_completion` | نسبة إنجاز المهام (حاليًا = 100) |
| `current_streak` | سلسلة الحضور الحالية |
| `longest_streak` | أطول سلسلة حضور |
| `total_delay_minutes` | إجمالي دقائق التأخير |
| `total_overtime_minutes` | إجمالي دقائق الإضافي |
| `manual_adjustments` | التعديلات اليدوية من score_adjustments |

### مثال معادلة

```
(on_time_rate * 0.4) + (attendance * 0.3) + (current_streak * 2) - (delay_rate * 0.2)
```

### الأمان
- المعادلات تُقيَّم عبر `ExpressionLanguage` وليس `eval()` — آمنة من حقن الكود
- إجراء "اختبار المعادلة" في ReportFormulaResource يتيح التحقق قبل التفعيل

---

## 6.7 ساعة الفرصة الضائعة (Lost Opportunity Clock)

خاصية فريدة تعرض **تكلفة التأخير المتراكمة لحظيًا** عبر جميع الفروع:

```php
// AnalyticsService::getLostOpportunityClock()
لكل فرع نشط:
  - تجميع delay_cost + early_leave_cost من سجلات اليوم
  - حساب خسارة الغياب = (موظفون نشطون - حاضرون) × VPM × دقائق_الوردية
  
النتيجة:
  - total_loss: إجمالي الخسارة (ر.س)
  - total_delay_minutes: إجمالي دقائق التأخير
  - absent_count: عدد الغائبين
  - branches: تفصيل أعلى 5 فروع خسارة
```

**تتحدث تلقائيًا** كل 60 ثانية في لوحة المعلومات.

---

> **السابق**: [مكونات Filament](05-filament-components.md) | **التالي**: [نظام الحضور](07-attendance-system.md)

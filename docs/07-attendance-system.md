# 7. ูุธุงู ุงูุญุถูุฑ ูุงูุงูุตุฑุงู

## 7.1 ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุญุถูุฑ ุฐูู ูุนุชูุฏ ุนูู **GPS + ุงูุณูุงุฌ ุงูุฌุบุฑุงูู** ูุน ุฏุนู ููุงุณุชุซูุงุกุงุช ูุงููุนุงูุฌุฉ ุบูุฑ ุงููุชุฒุงููุฉ.

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                ุชุฏูู ุชุณุฌูู ุงูุญุถูุฑ                 โ
โ                                                  โ
โ   ๐ฑ ุงูููุธู ููุชุญ ุงูุชุทุจูู                        โ
โ     โ                                            โ
โ   ๐ ูุฑุงุกุฉ GPS (latitude, longitude)             โ
โ     โ                                            โ
โ   ๐ POST /attendance/check-in                   โ
โ     โ                                            โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ   โ  AttendanceService::checkIn()        โ       โ
โ   โ  1. ุชุญุฏูุฏ ุงููุฑุน                      โ       โ
โ   โ  2. ูุญุต ุงูุณูุงุฌ ุงูุฌุบุฑุงูู              โ       โ
โ   โ  3. ูุญุต ุงูุงุณุชุซูุงุกุงุช                  โ       โ
โ   โ  4. ุชุญุฏูุฏ ุงููุฑุฏูุฉ                    โ       โ
โ   โ  5. ุชูููู ุงูุญุงูุฉ (ุญุงุถุฑ/ูุชุฃุฎุฑ)       โ       โ
โ   โ  6. ุชุฌููุฏ ุงูุจูุงูุงุช ุงููุงููุฉ            โ       โ
โ   โ  7. ุญูุธ ุงูุณุฌู                        โ       โ
โ   โ  8. ุฅุทูุงู ุญุฏุซ AttendanceRecorded     โ       โ
โ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
โ     โ                                            โ
โ   โ ุณุฌู ุงูุญุถูุฑ ูุญููุธ                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 7.2 ุฎุฏูุฉ ุงูุญุถูุฑ (AttendanceService)

### 7.2.1 `checkIn()` โ ุชุณุฌูู ุงูุญุถูุฑ

**ุงููุนุงููุงุช**: `User`, `$lat`, `$lng`, `$ip?`, `$device?`

**ุงูุชุฏูู ุงูููุตูู**:

1. **ุชุญุฏูุฏ ุงููุฑุน**: `$user->branch` โ ูุฌุจ ุฃู ูููู ููููุธู ูุฑุน ูุนููู
2. **ูุญุต ุงูุณูุงุฌ ุงูุฌุบุฑุงูู**:
   - ุญุณุงุจ ุงููุณุงูุฉ ุจู Haversine: `GeofencingService::validatePosition()`
   - ุฅุฐุง ุฎุงุฑุฌ ุงูุณูุงุฌ:
     - ุงููุณุชูู 10 ูุชุฌุงูุฒ (`bypass-geofence` Gate)
     - ุงุณุชุซูุงุก ุญุถูุฑ ูุดุท ูุน `bypass_geofence` ูุชุฌุงูุฒ
     - ูุฅูุง: `OutOfGeofenceException` ูุน ุงููุณุงูุฉ ูุงููุตู ูุทุฑ
3. **ุชุญุฏูุฏ ุงููุฑุฏูุฉ** (ุจุงูุฃููููุฉ):
   ```
   ุงุณุชุซูุงุก ุญุถูุฑ (custom_shift_start) โ ูุฑุฏูุฉ ุงููุณุชุฎุฏู ุงูุญุงููุฉ โ ูุฑุฏูุฉ ุงููุฑุน ุงูุงูุชุฑุงุถูุฉ
   ```
   ูุชุฑุฉ ุงูุณูุงุญ ุจููุณ ุงูุฃููููุฉ.
4. **ุฅูุดุงุก ุณุฌู ุงูุญุถูุฑ** ูุน ุจูุงูุงุช GPS ูIP ูุงูุฌูุงุฒ
5. **ุชูููู ุงูุญุงูุฉ**:
   - ุฅุฐุง ุงูููุช โค ุจุฏุงูุฉ_ุงููุฑุฏูุฉ + ูุชุฑุฉ_ุงูุณูุงุญ โ `present` (ุญุงุถุฑ)
   - ุฅุฐุง ุงูููุช > ุจุฏุงูุฉ_ุงููุฑุฏูุฉ + ูุชุฑุฉ_ุงูุณูุงุญ โ `late` (ูุชุฃุฎุฑ) + ุญุณุงุจ ุงูุฏูุงุฆู
   - ุฅุฐุง ุงุณุชุซูุงุก `bypass_late_flag` ูุดุท ููุชุฃุฎุฑ โ ููุญููู ุฅูู `present`
6. **ุชุฌููุฏ ุงูุจูุงูุงุช ุงููุงููุฉ**: `cost_per_minute` ูููุณุฎ ูู ุงูููุธู โ ุงูุณุฌู
7. **ุงูุญูุธ** ุซู ุฅุทูุงู `AttendanceRecorded` event

### 7.2.2 `checkOut()` โ ุชุณุฌูู ุงูุงูุตุฑุงู

**ุงููุนุงููุงุช**: `User`, `$lat`, `$lng`

1. **ุงูุจุญุซ ุนู ุณุฌู ุงูููู**: `firstOrFail()` โ ูุฑูู ุงุณุชุซูุงุก ุฅุฐุง ูู ููุฌุฏ
2. **ุชุณุฌูู ุจูุงูุงุช ุงูุงูุตุฑุงู**: GPS + ุญุงูุฉ ุงูุณูุงุฌ
3. **ุญุณุงุจ ุงูุฏูุงุฆู**: `check_in_at->diffInMinutes(now)`
4. **ููุงุฑูุฉ ูุน ุงููุฑุฏูุฉ**:
   - ุนูู > ุงููุทููุจ โ ุฅุถุงูู
   - ุนูู < ุงููุทููุจ โ ูุบุงุฏุฑุฉ ูุจูุฑุฉ
5. **ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุชูุงููู**:
   - `delay_cost = delay_minutes ร cost_per_minute`
   - `early_leave_cost = early_leave_minutes ร cost_per_minute`
   - `overtime_value = overtime_minutes ร cost_per_minute ร 1.5`

### 7.2.3 `queueCheckIn()` โ ุญุถูุฑ ุบูุฑ ูุชุฒุงูู

ููุฃููุงุช ุฐุงุช ุงูุถุบุท ุงูุนุงูู (ุจุฏุงูุฉ ุงูุฏูุงู):

```php
ProcessAttendanceJob::dispatch($user, $lat, $lng, $ip, $device);
// โ ูุนูุฏ: {status: 'processing', message: 'ุฌุงุฑู ูุนุงูุฌุฉ ุทูุจ ุงูุญุถูุฑ'}
```

---

## 7.3 ุงูุณูุงุฌ ุงูุฌุบุฑุงูู (GeofencingService)

### ูุนุงุฏูุฉ Haversine

```
distance = R ร 2 ร atan2(โa, โ(1-a))

ุญูุซ:
  a = sinยฒ(ฮlat/2) + cos(latโ) ร cos(latโ) ร sinยฒ(ฮlng/2)
  R = 6,371,000 ูุชุฑ (ูุตู ูุทุฑ ุงูุฃุฑุถ)
```

### ุงูุชุญูู

```php
$geo = $geofencing->validatePosition($branch, $lat, $lng);
// $geo['distance_meters']   โ 85.42
// $geo['within_geofence']   โ true (ุฅุฐุง โค geofence_radius)
```

### ุฅุนุฏุงุฏุงุช ุงูุณูุงุฌ ููู ูุฑุน

| ุงูุฅุนุฏุงุฏ | ุงูุงูุชุฑุงุถู | ุงููุตู |
|---------|-----------|-------|
| `latitude` / `longitude` | โ | ูุฑูุฒ ุงููุฑุน |
| `geofence_radius` | 100 ูุชุฑ | ูุตู ูุทุฑ ุงูุณูุงุฌ |

---

## 7.4 ูุญุฑู ุงูุงุณุชุซูุงุกุงุช (AttendanceException)

ุงุณุชุซูุงุกุงุช ุงูุญุถูุฑ ุชูุชูุญ ุชุฌุงูุฒ ุงูููุงุนุฏ ุงูููุงุณูุฉ ูููุธููู ูุญุฏุฏูู:

| ุงูููุน | ุงููุตู | ุงูุชุฌุงูุฒุงุช |
|-------|-------|-----------|
| `flexible_hours` | ุณุงุนุงุช ูุฑูุฉ | ูุฑุฏูุฉ ูุฎุตุตุฉ + ูุชุฑุฉ ุณูุงุญ ุฃุทูู |
| `remote_work` | ุนูู ุนู ุจุนุฏ | ุชุฌุงูุฒ ุงูุณูุงุฌ ุงูุฌุบุฑุงูู |
| `vip_bypass` | ุชุฌุงูุฒ VIP | ุชุฌุงูุฒ ุงูุณูุงุฌ + ุชุฌุงูุฒ ุนูู ุงูุชุฃุฎูุฑ |
| `medical` | ุญุงูุฉ ุทุจูุฉ | ูุชุฑุฉ ุณูุงุญ ุฅุถุงููุฉ + ุชุฌุงูุฒ ุงูุชุฃุฎูุฑ |
| `custom` | ูุฎุตุต | ุฃู ูุฒูุฌ ูู ุงูุชุฌุงูุฒุงุช |

### ุญููู ุงูุงุณุชุซูุงุก

```php
$exception->bypass_geofence    // ุชุฌุงูุฒ ูุญุต ุงูุณูุงุฌ
$exception->bypass_late_flag   // ุชุญููู "ูุชุฃุฎุฑ" ุฅูู "ุญุงุถุฑ"
$exception->custom_shift_start // ููุช ุจุฏุงูุฉ ูุฎุตุต
$exception->custom_shift_end   // ููุช ููุงูุฉ ูุฎุตุต
$exception->custom_grace_minutes // ูุชุฑุฉ ุณูุงุญ ูุฎุตุตุฉ
$exception->start_date / end_date // ูุชุฑุฉ ุณุฑูุงู ุงูุงุณุชุซูุงุก
```

---

## 7.5 ุญุงูุงุช ุงูุญุถูุฑ

| ุงูุญุงูุฉ | ุงูุดุฑุท |
|--------|-------|
| `present` | ุญุถูุฑ ูู ุงูููุช (ุถูู ูุชุฑุฉ ุงูุณูุงุญ) |
| `late` | ุญุถูุฑ ุจุนุฏ ูุชุฑุฉ ุงูุณูุงุญ |
| `absent` | ูุง ููุฌุฏ ุณุฌู ุญุถูุฑ |
| `on_leave` | ูู ุฅุฌุงุฒุฉ ูุนุชูุฏุฉ |
| `holiday` | ููู ุนุทูุฉ |
| `remote` | ุนูู ุนู ุจุนุฏ (ุงุณุชุซูุงุก) |
| `half_day` | ูุตู ููู |
| `exception` | ุงุณุชุซูุงุก ุฎุงุต |

---

## 7.6 ุทูุจุงุช ุงูุฅุฌุงุฒุฉ (LeaveRequest)

### ุฃููุงุน ุงูุฅุฌุงุฒุฉ

| ุงูููุน | ุงูุงุณู |
|-------|-------|
| `annual` | ุณูููุฉ |
| `sick` | ูุฑุถูุฉ |
| `emergency` | ุทุงุฑุฆุฉ |
| `unpaid` | ุจุฏูู ุฑุงุชุจ |
| `maternity` | ุฃูููุฉ |
| `paternity` | ุฃุจูุฉ |
| `hajj` | ุญุฌ |
| `death` | ููุงุฉ |
| `marriage` | ุฒูุงุฌ |

### ุฏูุฑุฉ ุญูุงุฉ ุงูุทูุจ

```
pending (ูุนููู) โ approved (ูุนุชูุฏ) / rejected (ูุฑููุถ)
                โ cancelled (ููุบู) โ ููุท ุงููุนููู ูููู ุฅูุบุงุคู
```

- ุงูููุธู ููุฏู ุงูุทูุจ (ูุณุชูู 1+)
- ุงููุดุฑู ูุนุชูุฏ/ูุฑูุถ (ูุณุชูู 5+)
- ุงูุทูุจ ุงููุนุชูุฏ ููุญููู ุณุฌูุงุช ุงูุญุถูุฑ ูุฃูุงู ุงูุฅุฌุงุฒุฉ ุฅูู `on_leave`

---

## 7.7 ุงููุฑุฏูุงุช (Shifts)

### ุจููุฉ ุงููุฑุฏูุฉ

```php
Shift {
    start_time: '08:00'
    end_time: '17:00'
    grace_period_minutes: 15
    is_overnight: false      // ูุฑุฏูุฉ ููููุฉ (ุชุชุฌุงูุฒ ููุชุตู ุงูููู)
    duration_minutes: 540    // ูุญุณูุจ
}
```

### ุฃููููุฉ ุชุญุฏูุฏ ุงููุฑุฏูุฉ

```
1. ุงุณุชุซูุงุก ุญุถูุฑ ูุดุท (custom_shift_start/end)
2. ุงููุฑุฏูุฉ ุงูุญุงููุฉ ููููุธู (user_shifts.is_current = true)
3. ุงููุฑุฏูุฉ ุงูุงูุชุฑุงุถูุฉ ูููุฑุน (branch.default_shift_start/end)
4. ุงูุงูุชุฑุงุถู: 480 ุฏูููุฉ (8 ุณุงุนุงุช)
```

---

## 7.8 ููุงุท ุงูุฏุฎูู (API Endpoints)

| ุงููุณุงุฑ | ุงูุทุฑููุฉ | ุงููุตู |
|--------|---------|-------|
| `POST /attendance/check-in` | ูุชุฒุงูู | ุชุณุฌูู ุญุถูุฑ ููุฑู |
| `POST /attendance/queue-check-in` | ุบูุฑ ูุชุฒุงูู | ุชุณุฌูู ุญุถูุฑ ุนุจุฑ queue |
| `POST /attendance/check-out` | ูุชุฒุงูู | ุชุณุฌูู ุงูุตุฑุงู |
| `GET /attendance/today` | โ | ุญุงูุฉ ุญุถูุฑ ุงูููู |

### ุงููุนุงููุงุช ุงููุทููุจุฉ (check-in)

```json
{
    "latitude": 24.7136,
    "longitude": 46.6753
}
```

### ุงูุงุณุชุฌุงุจุฉ

```json
{
    "status": "success",
    "data": {
        "id": 1234,
        "attendance_date": "2026-02-01",
        "check_in_at": "2026-02-01T08:05:00",
        "status": "present",
        "delay_minutes": 0,
        "distance_meters": 45.2,
        "within_geofence": true
    }
}
```

---

> **ุงูุณุงุจู**: [ุงููุธุงู ุงููุงูู](06-financial-system.md) | **ุงูุชุงูู**: [ูุธุงู ุงูุชุญูููุงุช](08-analytics-system.md)

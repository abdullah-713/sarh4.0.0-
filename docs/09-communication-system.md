# 9. نظام التواصل

## 9.1 نظرة عامة

يوفر سهر ثلاث قنوات تواصل: **المحادثات الفورية**، **التعاميم الرسمية**، و**الإذاعة العامة**.

```
┌────────────────────────────────────────────────────────────┐
│                    قنوات التواصل                            │
├──────────────────┬──────────────────┬──────────────────────┤
│  المحادثات       │  التعاميم        │  الإذاعة             │
│  (Messaging)     │  (Circulars)     │  (Broadcast)         │
├──────────────────┼──────────────────┼──────────────────────┤
│ مباشرة أو جماعية│ رسمية مع إقرار   │ إشعارات جماعية      │
│ Livewire         │ Filament Resource│ Filament Page        │
│ /messaging       │ /admin/circulars │ /admin/broadcast     │
│ مستوى 1+        │ إنشاء: مستوى 5+ │ مستوى 7+            │
└──────────────────┴──────────────────┴──────────────────────┘
```

---

## 9.2 المحادثات (Conversations)

### البنية

```
conversations (1) ←→ (N) conversation_participants ←→ (1) users
conversations (1) ←→ (N) messages ←→ (1) users (sender)
```

### أنواع المحادثات

| النوع | الوصف |
|-------|-------|
| `direct` | محادثة بين شخصين |
| `group` | محادثة جماعية |

### مكونات Livewire

#### MessagingInbox — صندوق الوارد
- **المسار**: `/messaging`
- **الوظيفة**: عرض قائمة المحادثات مع عدد الرسائل غير المقروءة
- **الإجراءات**: فتح محادثة، إنشاء محادثة جديدة

#### MessagingChat — نافذة المحادثة
- **المسار**: `/messaging/{conversation}`
- **الوظيفة**: عرض الرسائل، إرسال رسائل جديدة
- **الإجراءات**: إرسال نص/صورة/ملف، تعليم كمقروء تلقائيًا

### أنواع الرسائل

| النوع | الوصف |
|-------|-------|
| `text` | نص عادي |
| `image` | صورة مرفقة |
| `file` | ملف مرفق |

---

## 9.3 التعاميم (Circulars)

### الإنشاء (CircularResource)

| الحقل | الوصف |
|-------|-------|
| `title_ar` / `title_en` | العنوان |
| `body_ar` / `body_en` | المحتوى (محرر نصوص غني) |
| `priority` | عادي / مرتفع / عاجل |
| `target_scope` | نطاق الاستهداف |
| `requires_acknowledgment` | يتطلب إقرار بالقراءة |
| `published_at` | تاريخ النشر |
| `expires_at` | تاريخ الانتهاء |

### نطاقات الاستهداف

| النطاق | الوصف |
|--------|-------|
| `all` | جميع الموظفين |
| `branch` | فرع محدد (`target_branch_id`) |
| `department` | قسم محدد (`target_department_id`) |
| `role` | دور محدد (`target_role_id`) |

### الإقرار

```
circulars (1) ←→ (N) circular_acknowledgments ←→ (1) users
```

- إذا `requires_acknowledgment = true`: يجب على كل موظف مستهدف تأكيد القراءة
- يُعرض عدد الإقرارات في قائمة التعاميم

### مكون Livewire

#### CircularsWidget — أداة التعاميم
- **الموقع**: بوابة الموظف
- **الوظيفة**: عرض التعاميم الموجهة للموظف مع زر الإقرار
- **التصفية**: حسب فرع وقسم ودور الموظف

### إرسال التعميم (SendCircularJob)

```php
SendCircularJob::dispatch($circular, $userIds);
// → يُنشئ PerformanceAlert لكل موظف (إشعار داخلي)
// → يُعالج على دفعات (100 موظف/دفعة) مع توقف 1 ثانية
// → Timeout: 120 ثانية، 2 محاولات
```

---

## 9.4 الإذاعة (BroadcastPage)

صفحة Filament لإرسال إشعارات جماعية:

- **الوصول**: المستوى 7+
- **النطاقات**: الكل / فرع / قسم
- يُنشئ إشعارات `database` لكل موظف مستهدف
- مناسب للإعلانات السريعة دون الحاجة لمتابعة الإقرار

---

## 9.5 البلاغات السرية (Whistleblower)

### تقديم البلاغ (WhistleblowerForm)

- **المسار**: `/whistleblower`
- **المصادقة**: **لا تتطلب تسجيل دخول** — متاحة للعموم
- **البيانات**:
  - التصنيف: فساد، تحرش، سلامة، احتيال
  - الخطورة: منخفضة، متوسطة، عالية، حرجة
  - المحتوى: يُشفّر فورًا عبر `encrypt()`
  - الدليل: ملف مرفق (اختياري)
- **النتيجة**: رقم تذكرة (`WB-YMDHIS-RAND`) + رمز تتبع مجهول

### تتبع البلاغ (WhistleblowerTrack)

- **المسار**: `/whistleblower/track`
- **المصادقة**: لا تتطلب
- يُدخل المُبلّغ رمز التتبع المجهول
- يرى الحالة فقط (جديد/قيد التحقيق/محلول/مرفوض) — لا يرى المحتوى أبدًا

### الخزنة السرية (WhistleblowerVaultPage)

- **الوصول**: المستوى 10 فقط
- عرض جميع البلاغات مع فك التشفير
- كل عملية فتح تُسجَّل في `AuditLog`

---

> **السابق**: [نظام التحليلات](08-analytics-system.md) | **التالي**: [نظام التحفيز](10-gamification-system.md)
